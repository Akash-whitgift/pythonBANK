<!DOCTYPE html>
<html lang="en">
<head>
    <title>Messenger</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='stylemessage.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
  <script defer>
    var socket = io.connect('https://' + document.domain + ':' + location.port, {
      transports: ['websocket']
    });
    socket.on('connect', function() {
        console.log('Connected to server');
    });
    socket.on('new_message', function(data) {
    // Update the UI with the received message
    console.log('Received a new message:', data);

    // Trigger the loadChat function for the recipient's username
    loadChat(data.sender);
    });
    socket.on('message', function (data) {
        // Log a message to the console when a new message is received
        console.log('Received a new message:', data);

        // Call appendMessages to add the new message to the container
        appendMessages([data]);
    });

    function loadChat(username) {
      console.log("loading chat")
        document.getElementById('currentChat').innerText = username;

        // Fetch and display chat messages for the selected user
        loadPastMessages(username);
    }

    function loadPastMessages(username) {
        // Assuming you have a function to fetch past messages from the server
        fetch(`/get_messages?username=${username}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(messages => {
            // Instead of replacing the HTML, append new messages to the container
            displayMessages(messages);
        })
        .catch(error => console.error('Error loading past messages:', error));
    }

    function appendMessages(messages) {
        const messageContainer = document.querySelector('.messagecard');

        // Iterate through messages and append them to the container
        messages.forEach(message => {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.innerHTML = `<strong>${message.sender}:</strong> ${message.message}`;
            messageContainer.appendChild(messageElement);
        });

        // Optionally, scroll to the bottom of the message container
        messageContainer.scrollTop = messageContainer.scrollHeight;
    }

    function displayMessages(messages) {
        const messageContainer = document.querySelector('.messagecard');
        messageContainer.innerHTML = '';
        // Iterate through messages and append them to the container
        messages.forEach(message => {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.innerHTML = `<strong>${message.sender}:</strong> ${message.message}`;
            messageContainer.appendChild(messageElement);
        });
      messageContainer.scrollTop = 0;
    }
    function sendMessage() {
        var recipient = document.getElementById('currentChat').innerText;
        var message = document.getElementById('messageInput').value;
        // Send the message to the server
        socket.emit('send_message', {
            recipient: recipient,
            message: message
        });
        console.log("message sent")
        // Clear the message input
        document.getElementById('messageInput').value = '';
      username = document.getElementById('currentChat').innerText;
      loadChat(username)
    }
    function createChat() {
      var username = document.getElementById('newChatUsername').value;
      console.log(username);
      loadChat(username);
    }
    // Handle real-time updates for past messages
    socket.on('message', function (data) {
        // Update the UI with the received message
      console.log("message recieved")
        const messageContainer = document.querySelector('.messagecard');
        const messageElement = document.createElement('div');
        messageElement.className = 'message';
        messageElement.innerHTML = `<strong>${data.sender}:</strong> ${data.message}`;
        messageContainer.appendChild(messageElement);
    });
  </script>
</head>
  <body>
    <div class='container'>
  <div class="sidebar">
      <h2>Chats</h2>
      <ul class="chat-list">
        <input type="text" id="newChatUsername" placeholder="Enter username">
        <button onclick="createChat()">Create Chat</button>
        {% for username in active_chats %}
            <li class="chat-list-item" onclick="loadChat('{{ username }}')">{{ username }}</li>
        {% endfor %}
      </ul>
  </div>

  <div class="chat-area">
      <div class="chat-header">
          <h1>Messaging</h1>
          <p><strong>Current Chat:</strong> <span id="currentChat"></span></p>
      </div>
      <ul id="messageList" class="messagecard"></ul>
      <textarea class="message-input" id="messageInput" rows="5" placeholder="Type your message here"></textarea>
      <button class="send-button" onclick="sendMessage()">Send</button>
    <a href='/dashboard'><button class='ui'>Back to Dashboard</button></a>
  </div>
    </div>
  </body>
</html>
